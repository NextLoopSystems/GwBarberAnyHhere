{% extends "base.html" %}

{% block title %}Dashboard | Gw Barber{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
    .content-header h1 { font-weight: 700; margin-bottom: 0; color: var(--text-primary); font-size: 1.8rem; }
    .kpi-card, .chart-card, .filter-card, .welcome-card, .list-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.5rem; }
    .welcome-card { background: linear-gradient(135deg, var(--accent-color), #0056b3); color: white; border: none; }
    .filter-card .card-body { padding: 1rem 1.25rem; }
    .filter-card .form-label { font-size: 0.8rem; margin-bottom: 0.25rem; color: var(--text-secondary); }
    .chart-card .card-title, .list-card .card-title { color: var(--text-primary); }
    .kpi-card .card-body { position: relative; padding: 1.25rem; }
    .kpi-card .text-muted { color: var(--text-secondary) !important; }
    .kpi-card .kpi-value { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
    .kpi-card .kpi-icon { font-size: 2.5rem; opacity: 0.1; position: absolute; bottom: 5px; right: 15px; color: var(--accent-color); }
    body.dark-mode .kpi-card .kpi-icon { color: var(--text-primary); opacity: 0.05; }
    .kpi-lucro .kpi-value { color: var(--green-color); }
    .kpi-gasto .kpi-value { color: var(--red-color); }
    body.dark-mode .kpi-lucro .kpi-value { color: var(--dark-green-color); }
    .list-card .list-group-item { background-color: transparent; border-color: var(--content-border); color: var(--text-primary); }

    /* Estilos para o Select2 se adaptar ao tema escuro */
    .select2-container--bootstrap-5 .select2-selection {
        background-color: var(--input-bg);
        border-color: var(--content-border);
        color: var(--text-primary);
        font-size: 0.875rem; /* Ajuste do tamanho da fonte para sm */
        padding: 0.25rem 0.5rem;
        height: calc(1.5em + 0.5rem + 2px);
    }
    .select2-container--bootstrap-5.select2-container--open .select2-selection {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
    }
    .select2-container--bootstrap-5 .select2-dropdown {
        background-color: var(--content-bg);
        border-color: var(--content-border);
    }
    .select2-container--bootstrap-5 .select2-results__option {
        color: var(--text-primary);
    }
    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background-color: var(--accent-color);
        color: white;
    }
    .select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field {
        background-color: var(--input-bg);
        border-color: var(--content-border);
        color: var(--text-primary);
    }
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        color: var(--text-primary);
        line-height: 1.5;
    }
</style>
{% endblock %}


{% block content %}
<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1 class="flex-grow-1 text-center">Dashboard</h1>
</div>

<div class="card welcome-card p-3 shadow-sm mb-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-graph-up-arrow display-6 mx-3"></i>
        <div>
            <h5 class="mb-0">Bem-vindo(a) de volta, {{ session.usuario }}!</h5>
            <p class="mb-0 opacity-75" style="font-size: 0.9rem;">Aqui está um resumo do desempenho.</p>
        </div>
    </div>
</div>

<div class="row mb-4">
    {% if session.is_admin %}
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card filter-card shadow-sm">
            <div class="card-body">
                <label for="filtro-barbeiro" class="form-label"><i class="bi bi-person-badge"></i> Filtro por Barbeiro</label>
                <select id="filtro-barbeiro" class="form-select form-select-sm" style="width: 100%;">
                    <option value="">Todos</option>
                    {% for b in barbeiros %}<option value="{{ b }}">{{ b }}</option>{% endfor %}
                </select>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="{% if session.is_admin %}col-md-6{% else %}col-12{% endif %}">
        <div class="card filter-card shadow-sm">
            <div class="card-body">
                <label for="filtro-periodo" class="form-label"><i class="bi bi-calendar-range"></i> Filtro por Período</label>
                <select id="filtro-periodo" class="form-select form-select-sm">
                    <option value="all" selected>Todo o Período</option>
                    <option value="today">Hoje</option>
                    <option value="week">Esta Semana</option>
                    <option value="month">Este Mês</option>
                    <option value="year">Este Ano</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3"><div class="card kpi-card shadow-sm h-100"><div class="card-body"><i class="bi bi-people-fill kpi-icon"></i><div class="text-muted">Clientes Assinantes</div><div id="total-assinantes" class="kpi-value">0</div></div></div></div>
    
    <div class="col-md-4 mb-3"><div class="card kpi-card shadow-sm h-100"><div class="card-body"><i class="bi bi-check-circle-fill kpi-icon"></i><div class="text-muted">Total Amortizado</div><div id="total-amortizado" class="kpi-value">R$ 0,00</div></div></div></div>
    <div class="col-md-4 mb-3"><div class="card kpi-card kpi-gasto shadow-sm h-100"><div class="card-body"><i class="bi bi-wallet2 kpi-icon"></i><div class="text-muted">Total Gasto (Contas)</div><div id="total-gastos" class="kpi-value">R$ 0,00</div></div></div></div>
    
    <div class="col-md-4 mb-3"><div class="card kpi-card shadow-sm h-100"><div class="card-body"><i class="bi bi-scissors kpi-icon"></i><div class="text-muted">Faturamento Bruto Serviços</div><div id="total-servicos" class="kpi-value">R$ 0,00</div></div></div></div>
    <div class="col-md-4 mb-3"><div class="card kpi-card shadow-sm h-100"><div class="card-body"><i class="bi bi-box-seam kpi-icon"></i><div class="text-muted">Faturamento Bruto Vendas</div><div id="total-vendas" class="kpi-value">R$ 0,00</div></div></div></div>
    <div class="col-md-4 mb-3"><div class="card kpi-card shadow-sm h-100"><div class="card-body"><i class="bi bi-cash-stack kpi-icon"></i><div class="text-muted">Faturamento Bruto Total</div><div id="total-geral" class="kpi-value">R$ 0,00</div></div></div></div>
    {% if session.is_admin %}
    <div class="col-md-4 mb-3"><div class="card kpi-card kpi-lucro shadow-sm h-100"><div class="card-body"><i class="bi bi-graph-up-arrow kpi-icon"></i><div class="text-muted">Faturamento Líquido Serviços</div><div id="liquido-servicos" class="kpi-value">R$ 0,00</div></div></div></div>
    <div class="col-md-4 mb-3"><div class="card kpi-card kpi-lucro shadow-sm h-100"><div class="card-body"><i class="bi bi-cash-coin kpi-icon"></i><div class="text-muted">Faturamento Líquido Total</div><div id="liquido-total" class="kpi-value">R$ 0,00</div></div></div></div>
    {% endif %}
</div>

<div class="row">
    <div class="col-lg-6 mb-4"><div class="card chart-card shadow-sm"><div class="card-body"><h5 class="card-title">Serviços por Barbeiro</h5><div style="height: 280px;"><canvas id="grafico-servicos"></canvas></div></div></div></div>
    <div class="col-lg-6 mb-4"><div class="card chart-card shadow-sm"><div class="card-body"><h5 class="card-title">Vendas por Barbeiro</h5><div style="height: 280px;"><canvas id="grafico-vendas"></canvas></div></div></div></div>
    <div class="col-lg-6 mb-4"><div class="card chart-card shadow-sm"><div class="card-body"><h5 class="card-title">Produtos em Estoque</h5><div style="height: 280px;"><canvas id="grafico-produtos"></canvas></div></div></div></div>
    <div class="col-lg-6 mb-4"><div class="card chart-card shadow-sm"><div class="card-body"><h5 class="card-title">Gastos Mensais</h5><div style="height: 280px;"><canvas id="grafico-gastos"></canvas></div></div></div></div>
    <div class="col-lg-6 mb-4">
        <div class="card chart-card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Top 5 Serviços Realizados</h5>
                <div style="height: 280px;"><canvas id="grafico-top-servicos"></canvas></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card list-card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Clientes com Assinatura Ativa</h5>
                <div id="lista-assinantes" class="list-group list-group-flush" style="height: 280px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_libs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}


{% block scripts %}
<script>
$(document).ready(function() {
    $('#filtro-barbeiro').select2({
        theme: 'bootstrap-5'
    });
    
    const body = document.body;
    let charts = {};

    const kpiTotalAssinantes = document.getElementById('total-assinantes');
    const kpiTotalAmortizado = document.getElementById('total-amortizado');
    const kpiTotalGastos = document.getElementById('total-gastos');
    const kpiTotalServicos = document.getElementById('total-servicos');
    const kpiTotalVendas = document.getElementById('total-vendas');
    const kpiTotalGeral = document.getElementById('total-geral');
    const kpiLiquidoServicos = document.getElementById('liquido-servicos');
    const kpiLiquidoTotal = document.getElementById('liquido-total');

    function formatCurrency(value) {
        return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function createChart(ctx) {
        if (!ctx) return;
        const chartId = ctx.canvas.id;
        if (charts[chartId]) charts[chartId].destroy();
        
        let chartType = 'bar';
        let legendDisplay = false;

        if (chartId === 'grafico-top-servicos') {
            chartType = 'pie';
            legendDisplay = true;
        }

        charts[chartId] = new Chart(ctx, {
            type: chartType,
            data: {},
            options: {
                maintainAspectRatio: false, responsive: true,
                plugins: { legend: { display: legendDisplay, position: 'right' } },
                scales: chartType === 'bar' ? {
                    y: { beginAtZero: true, ticks: { color: getComputedStyle(body).getPropertyValue('--text-secondary') }, grid: { color: getComputedStyle(body).getPropertyValue('--content-border') } },
                    x: { ticks: { color: getComputedStyle(body).getPropertyValue('--text-secondary') }, grid: { color: 'transparent' } }
                } : {}
            }
        });
    }

    ['grafico-servicos', 'grafico-vendas', 'grafico-produtos', 'grafico-gastos', 'grafico-top-servicos'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) createChart(canvas.getContext('2d'));
    });

    function updateChartData(chartId, labels, data, label) {
        const chart = charts[chartId];
        if (!chart) return;

        const pieColors = ['#0d6efd', '#6f42c1', '#198754', '#ffc107', '#dc3545'];
        const pieBorders = ['#0b5ed7', '#5d3d9b', '#157347', '#d9a406', '#b02a37'];
        
        let backgroundColors = 'rgba(13, 110, 253, 0.5)';
        let borderColors = 'rgba(13, 110, 253, 1)';

        if (chart.config.type === 'pie') {
            backgroundColors = pieColors;
            borderColors = pieBorders;
        } else if (chartId === 'grafico-gastos') {
            backgroundColors = 'rgba(220, 53, 69, 0.5)';
            borderColors = 'rgba(220, 53, 69, 1)';
        }

        chart.data.labels = labels;
        chart.data.datasets = [{ 
            label: label, data: data, backgroundColor: backgroundColors, 
            borderColor: borderColors, borderWidth: 1, borderRadius: 4 
        }];
        chart.update();
    }

    async function fetchDashboardData() {
        const barbeiro = $('#filtro-barbeiro').val() || '';
        const period = $('#filtro-periodo').val() || 'all';
        let inicio = '';
        let fim = '';
        
        if (period !== 'all') {
            const hoje = new Date();
            const fimDate = new Date();
            let inicioDate = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            switch (period) {
                case 'today': inicioDate = hoje; break;
                case 'week': inicioDate.setDate(hoje.getDate() - hoje.getDay()); break;
                case 'month': inicioDate = new Date(hoje.getFullYear(), hoje.getMonth(), 1); break;
                case 'year': inicioDate = new Date(hoje.getFullYear(), 0, 1); break;
            }
            inicio = inicioDate.toISOString().split('T')[0];
            fim = fimDate.toISOString().split('T')[0];
        }

        let url = `/api/dashboard_data?barbeiro=${barbeiro}`;
        if (inicio && fim) {
            url += `&inicio=${inicio}&fim=${fim}`;
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            if (kpiTotalAssinantes) kpiTotalAssinantes.textContent = data.total_assinantes;
            if (kpiTotalServicos) kpiTotalServicos.textContent = formatCurrency(data.total_servicos_faturado);
            if (kpiTotalVendas) kpiTotalVendas.textContent = formatCurrency(data.total_vendas_faturado);
            if (kpiTotalGeral) kpiTotalGeral.textContent = formatCurrency(data.faturamento_total);
            if (kpiTotalAmortizado) kpiTotalAmortizado.textContent = formatCurrency(data.total_amortizado);
            if (kpiTotalGastos) kpiTotalGastos.textContent = formatCurrency(data.total_gastos);
            if (kpiLiquidoServicos) kpiLiquidoServicos.textContent = formatCurrency(data.liquido_servicos);
            if (kpiLiquidoTotal) kpiLiquidoTotal.textContent = formatCurrency(data.liquido_total);
            
            updateChartData('grafico-servicos', data.servicos_por_barbeiro.labels, data.servicos_por_barbeiro.data, 'Serviços');
            updateChartData('grafico-vendas', data.vendas_por_barbeiro.labels, data.vendas_por_barbeiro.data, 'Vendas');
            updateChartData('grafico-produtos', data.produtos_em_estoque.labels, data.produtos_em_estoque.data, 'Quantidade');
            if (document.getElementById('grafico-gastos')) fetchGastosData(period);
            if (document.getElementById('grafico-top-servicos')) updateChartData('grafico-top-servicos', data.top_servicos.labels, data.top_servicos.data, 'Top 5 Serviços');
            if (document.getElementById('lista-assinantes')) fetchAssinantes();
        } catch (error) { console.error("Erro ao buscar dados do dashboard:", error); }
    }

    async function fetchGastosData(period) {
        try {
            const response = await fetch(`/api/contas`);
            const contas = await response.json();
            const parcelas = contas.flatMap(conta => {
                if (!conta.amortizar) return [{ data: new Date(conta.data_registro), valor: conta.valor }];
                const arr = [];
                const vParcela = conta.valor / conta.meses_amortizar;
                let dParcela = new Date(conta.data_registro);
                for (let i = 0; i < conta.meses_amortizar; i++) {
                    arr.push({ data: new Date(dParcela), valor: vParcela });
                    dParcela.setMonth(dParcela.getMonth() + 1);
                }
                return arr;
            });
            const gastosPorMes = parcelas.reduce((acc, p) => {
                const label = p.data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                if (!acc[label]) acc[label] = 0;
                acc[label] += p.valor;
                return acc;
            }, {});
            const labels = Object.keys(gastosPorMes).sort((a,b) => new Date('01 ' + a.replace('/',' ')) - new Date('01 ' + b.replace('/',' ')));
            const data = labels.map(label => gastosPorMes[label]);
            updateChartData('grafico-gastos', labels, data, 'Gastos');
        } catch (error) { console.error("Erro ao buscar dados de gastos:", error); }
    }

    async function fetchAssinantes() {
        const listaContainer = document.getElementById('lista-assinantes');
        try {
            const response = await fetch('/clientes_assinatura');
            const assinantes = await response.json();
            listaContainer.innerHTML = '';
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            const assinantesAtivos = assinantes.filter(a => a.data_final && new Date(a.data_final) >= hoje);
            if (assinantesAtivos.length === 0) {
                listaContainer.innerHTML = '<div class="list-group-item text-muted">Nenhum assinante ativo.</div>';
                return;
            }
            assinantesAtivos.sort((a, b) => new Date(a.data_final) - new Date(b.data_final));
            assinantesAtivos.forEach(assinante => {
                const dataFinal = new Date(assinante.data_final);
                const dataFinalFormatada = new Date(dataFinal.valueOf() + dataFinal.getTimezoneOffset() * 60000).toLocaleDateString('pt-BR');
                listaContainer.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center">${assinante.nome}<span class="badge bg-success rounded-pill">Vence em: ${dataFinalFormatada}</span></div>`;
            });
        } catch(error) {
            listaContainer.innerHTML = '<div class="list-group-item text-danger">Erro ao carregar assinantes.</div>';
        }
    }

    $('#filtro-barbeiro').on('change', fetchDashboardData);
    $('#filtro-periodo').on('change', fetchDashboardData);
    fetchDashboardData();
});
</script>
{% endblock %}