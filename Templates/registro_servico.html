{% extends "base.html" %}

{% block title %}Registro de Serviço | Gw Barber{% endblock %}

{% block head %}
<style>
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
    .content-header h1 { font-weight: 700; margin-bottom: 0; }
    .form-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.75rem; padding: 2rem; }
    .form-card h1 { text-align: center; color: var(--text-primary); font-size: 1.8rem; font-weight: 600; margin-bottom: 2rem; }
    .form-label { font-weight: 500; color: var(--text-secondary); }
    .form-control, .form-select { background-color: var(--input-bg); border: 1px solid var(--content-border); color: var(--text-primary); }
    .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; }
    .spinner-border { width: 4rem; height: 4rem; }
    #clientesDropdown .list-group-item { cursor: pointer; }
    #clientesDropdown .list-group-item.dark-mode { background-color: #2b2d31; color: #e9ecef; border-color: var(--content-border); }
    #clientesDropdown .list-group-item.dark-mode:hover { background-color: #343a40; color: #ffffff; }

    /* ************************************** */
    /* MUDANÇA AQUI: Correção para o tema escuro */
    .form-control:focus, .form-select:focus { 
        background-color: var(--content-bg); 
        border-color: var(--accent-color); 
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        color: var(--text-primary);
    }

    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active,
    select:-webkit-autofill,
    select:-webkit-autofill:hover,
    select:-webkit-autofill:focus {
        -webkit-text-fill-color: var(--text-primary) !important;
        -webkit-box-shadow: 0 0 0 30px var(--input-bg) inset !important;
        transition: background-color 5000s ease-in-out 0s;
    }
    /* ************************************** */
</style>
{% endblock %}


{% block content %}
<div class="overlay" id="loadingOverlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Enviando...</span>
    </div>
</div>

<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1 class="flex-grow-1 text-center"><i class="bi bi-scissors"></i> Registro de Serviço</h1>
</div>

<div class="card shadow-sm form-card mx-auto" style="max-width: 600px;">
    <form id="formAgendamento">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="barbeiro" class="form-label"><i class="bi bi-person-badge"></i> Barbeiro</label>
                <select class="form-select" id="barbeiro">
                    <option>Guilherme</option>
                    <option>Diego</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="dataHora" class="form-label"><i class="bi bi-calendar-event"></i> Data e Hora</label>
                <input type="datetime-local" class="form-control" id="dataHora" required>
            </div>
            <div class="col-12">
                <label for="servico" class="form-label"><i class="bi bi-tools"></i> Serviço</label>
                <select class="form-select" id="servico">
                    <option>Corte</option>
                    <option>Barba</option>
                    <option>Corte e Barba</option>
                    <option>Sobrancelha</option>
                    <option>Corte e Sobrancelha</option>
                    <option>Barba e Sobrancelha</option>
                    <option>Corte, Barba e Sobrancelha</option>
                    <option>Assinatura mensal Corte</option>
                    <option>Assinatura mensal Corte e Barba</option>
                </select>
            </div>
            <div class="col-md-8 position-relative">
                <label for="cliente" class="form-label"><i class="bi bi-person-circle"></i> Nome do Cliente</label>
                <input type="text" class="form-control" id="cliente" placeholder="Digite o nome do cliente" autocomplete="off" required data-cliente-id="">
                <div id="clientesDropdown" class="list-group position-absolute w-100" style="z-index:1000; display:none;"></div>
            </div>
            <div class="col-md-4">
                <label for="valor" class="form-label"><i class="bi bi-currency-dollar"></i> Valor</label>
                <input type="text" class="form-control" id="valor" placeholder="R$ 0,00">
            </div>
            <div class="d-flex gap-2 mt-4">
                <button type="submit" id="btnEnviar" class="btn btn-primary flex-fill py-2 fs-5">
                    <i class="bi bi-send-fill"></i> Enviar Registro
                </button>
                <button type="button" id="btnCorteAssinatura" class="btn btn-success flex-fill py-2 fs-5">
                    <i class="bi bi-card-list"></i> Corte Assinatura
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const body = document.body;
    let corteAssinaturaSelecionado = false;

    // --- LÓGICA ESPECÍFICA DESTA PÁGINA ---

    function isAssinatura(servico) {
        return servico.startsWith("Assinatura");
    }

    function add30Days(dataHora) {
        const data = new Date(dataHora);
        data.setDate(data.getDate() + 30);
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }
    
    const dataHoraInput = document.getElementById("dataHora");
    const now = new Date();
    dataHoraInput.value = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

    const servicoSelect = document.getElementById("servico");
    const valorInput = document.getElementById("valor");
    const precos = {
        "Corte": 35, "Barba": 32, "Corte e Barba": 60, "Sobrancelha": 15, "Corte e Sobrancelha": 50,
        "Barba e Sobrancelha": 45, "Corte, Barba e Sobrancelha": 70,
        "Assinatura mensal Corte": 129.90, "Assinatura mensal Corte e Barba": 189.90
    };

    let valorEditadoManualmente = false;
    valorInput.addEventListener("input", () => valorEditadoManualmente = true);

    function formatAsCurrency(value) {
        if (!value) return '';
        let num = parseFloat(String(value).replace(/\D/g, '')) / 100;
        return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    valorInput.addEventListener('input', (e) => {
        e.target.value = formatAsCurrency(e.target.value);
    });

    function atualizarValor() {
        if (!valorEditadoManualmente) {
            const servico = servicoSelect.value;
            const valor = precos[servico] || 0;
            valorInput.value = formatAsCurrency(valor.toString());
        }
    }

    servicoSelect.addEventListener("change", () => {
        valorEditadoManualmente = false;
        atualizarValor();
    });
    atualizarValor();

    document.querySelector("#formAgendamento").addEventListener("submit", async function (e) {
        e.preventDefault();
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = "flex";

        const clienteInput = document.getElementById("cliente");

        try {
            let response;
            if (corteAssinaturaSelecionado) {
                response = await fetch("/incrementar_corte", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: clienteInput.dataset.clienteId })
                });
            } else {
                const dados = {
                    barbeiro: document.querySelector("#barbeiro").value,
                    servico: servicoSelect.value,
                    cliente: clienteInput.value,
                    valor: valorInput.value,
                    dataHora: dataHoraInput.value,
                    dataFinal: isAssinatura(servicoSelect.value) ? add30Days(dataHoraInput.value) : null
                };
                response = await fetch("{{ url_for('registro_servico') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dados)
                });
            }

            const result = await response.json();
            if (response.ok) {
                alert(result.message);
                this.reset();
                corteAssinaturaSelecionado = false;
                clienteInput.dataset.clienteId = "";
                dataHoraInput.value = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                atualizarValor();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error("Erro no envio:", error);
            alert("Falha ao enviar os dados: " + error.message);
        } finally {
            overlay.style.display = "none";
        }
    });

    document.getElementById("btnCorteAssinatura").addEventListener("click", async () => {
        try {
            const barbeiro = document.getElementById("barbeiro").value;
            const resp = await fetch(`/clientes_assinatura?barbeiro=${encodeURIComponent(barbeiro)}`);
            const clientes = await resp.json();
            const dropdown = document.getElementById("clientesDropdown");
            dropdown.innerHTML = "";
            dropdown.style.display = "block";

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); // Normaliza para o início do dia
            const clientesAtivos = clientes.filter(c => c.data_final && new Date(c.data_final) >= hoje);

            if (clientesAtivos.length === 0) {
                dropdown.innerHTML = `<div class="list-group-item text-muted">Nenhum cliente com assinatura ativa.</div>`;
                return;
            }

            clientesAtivos.forEach(cliente => {
                const item = document.createElement("button");
                item.type = "button";
                item.className = "list-group-item list-group-item-action";
                const dataFinal = new Date(cliente.data_final);
                const dataFinalFormatada = new Date(dataFinal.valueOf() + dataFinal.getTimezoneOffset() * 60000).toLocaleDateString('pt-BR');
                item.textContent = `${cliente.nome} (Vence em: ${dataFinalFormatada})`;
                if (body.classList.contains("dark-mode")) item.classList.add("dark-mode");

                item.onclick = () => {
                    const clienteInput = document.getElementById("cliente");
                    clienteInput.value = cliente.nome;
                    clienteInput.dataset.clienteId = cliente.id;
                    dropdown.style.display = "none";
                    corteAssinaturaSelecionado = true;
                };
                dropdown.appendChild(item);
            });
        } catch (err) {
            console.error(err);
        }
    });

    document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("clientesDropdown");
        if (!document.getElementById("cliente").contains(e.target) && !document.getElementById("btnCorteAssinatura").contains(e.target)) {
            dropdown.style.display = "none";
        }
    });
});
</script>
{% endblock %}