{% extends "base.html" %}

{% block title %}Gerenciar Usuários | Gw Barber{% endblock %}

{% block head %}
<style>
    .content-header h1 { font-weight: 700; margin-bottom: 0; color: var(--text-primary); font-size: 1.8rem; }
    .user-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.5rem; }
    .user-card .card-header { background-color: transparent; border-bottom: 1px solid var(--content-border); font-weight: 600; }
    .user-card .detail-item { display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.9rem; }
    .user-card .detail-label { color: var(--text-secondary); }
    .user-card .card-footer { background-color: transparent; border-top: 1px solid var(--content-border); }
    .action-btn { color: var(--text-secondary); }
    .action-btn.btn-edit:hover { color: var(--accent-color); }
    .action-btn.btn-delete:hover { color: #dc3545; }
    .modal-content { background-color: var(--content-bg); color: var(--text-primary); border-color: var(--content-border); }
    .modal-header { border-bottom-color: var(--content-border); }
    .modal-footer { border-top-color: var(--content-border); }
    .form-label, .form-check-label { font-weight: 500; color: var(--text-secondary); }
    body.dark-mode .form-check-label { color: var(--text-primary); }
    .form-control { background-color: var(--input-bg); border-color: var(--content-border); color: var(--text-primary); }
    .form-control:focus { background-color: var(--content-bg); border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
    body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1><i class="bi bi-people-fill"></i> Gerenciar Usuários</h1>
</div>
  
<div id="user-list-container" class="row">
    </div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3"><label for="edit-usuario" class="form-label">Usuário</label><input type="text" class="form-control" id="edit-usuario"></div>
                    <div class="mb-3"><label for="edit-senha" class="form-label">Nova Senha</label><input type="password" class="form-control" id="edit-senha" placeholder="Deixe em branco para não alterar"></div>
                    <div class="mb-3"><label for="edit-email" class="form-label">Email</label><input type="email" class="form-control" id="edit-email"></div>
                    <div class="mb-3"><label for="edit-telefone" class="form-label">Telefone</label><input type="tel" class="form-control" id="edit-telefone"></div>
                    <div class="mb-3"><label for="edit-cpf" class="form-label">CPF</label><input type="text" class="form-control" id="edit-cpf"></div>
                    <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="edit-is_admin"><label class="form-check-label" for="edit-is_admin">É Administrador</label></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-changes-btn">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const listContainer = document.getElementById('user-list-container');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    let usuariosData = [];

    async function carregarUsuarios() {
        try {
            const response = await fetch("{{ url_for('api_usuarios') }}");
            usuariosData = await response.json();
            listContainer.innerHTML = '';
            
            if (usuariosData.length === 0) {
                listContainer.innerHTML = `<div class="col-12"><div class="alert alert-info">Nenhum usuário cadastrado.</div></div>`;
                return;
            }

            usuariosData.forEach(user => {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-4';
                col.setAttribute('data-id', user.id);

                const adminBadge = user.is_admin 
                    ? `<span class="badge bg-primary rounded-pill">Admin</span>` 
                    : `<span class="badge bg-secondary rounded-pill">Usuário</span>`;
                
                col.innerHTML = `
                    <div class="card user-card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="user-name text-truncate"><i class="bi bi-person-fill me-2"></i>${user.usuario}</span>
                            ${adminBadge}
                        </div>
                        <div class="card-body py-2">
                            <div class="detail-item"><span class="detail-label">Email:</span> <span class="detail-value text-truncate">${user.email || 'N/A'}</span></div>
                            <div class="detail-item"><span class="detail-label">Telefone:</span> <span class="detail-value">${user.telefone || 'N/A'}</span></div>
                            <div class="detail-item"><span class="detail-label">CPF:</span> <span class="detail-value">${user.cpf || 'N/A'}</span></div>
                        </div>
                        <div class="card-footer text-end bg-transparent">
                            <button class="btn btn-link text-decoration-none p-0 ms-3 action-btn btn-edit" title="Editar"><i class="bi bi-pencil-fill fs-5"></i></button>
                            <button class="btn btn-link text-decoration-none p-0 ms-3 action-btn btn-delete" title="Excluir"><i class="bi bi-trash-fill fs-5"></i></button>
                        </div>
                    </div>`;
                listContainer.appendChild(col);
            });
        } catch (error) {
            listContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger">Não foi possível carregar os usuários.</div></div>`;
        }
    }

    listContainer.addEventListener('click', function (e) {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.closest('.col-lg-4').getAttribute('data-id');

        if (target.classList.contains('btn-delete')) {
            if (confirm(`Tem certeza que deseja excluir o usuário ID ${id}?`)) {
                fetch(`/api/usuario/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(result => {
                        alert(result.message);
                        if (result.success) carregarUsuarios();
                    });
            }
        }

        if (target.classList.contains('btn-edit')) {
            const user = usuariosData.find(u => u.id == id);
            if (user) {
                document.getElementById('edit-id').value = user.id;
                document.getElementById('edit-usuario').value = user.usuario;
                document.getElementById('edit-email').value = user.email || '';
                document.getElementById('edit-telefone').value = user.telefone || '';
                document.getElementById('edit-cpf').value = user.cpf || '';
                document.getElementById('edit-is_admin').checked = user.is_admin;
                document.getElementById('edit-senha').value = '';
                editModal.show();
            }
        }
    });
    
    document.getElementById('save-changes-btn').addEventListener('click', async function() {
        const id = document.getElementById('edit-id').value;
        const dados = {
            usuario: document.getElementById('edit-usuario').value,
            senha: document.getElementById('edit-senha').value,
            email: document.getElementById('edit-email').value,
            telefone: document.getElementById('edit-telefone').value,
            cpf: document.getElementById('edit-cpf').value,
            is_admin: document.getElementById('edit-is_admin').checked
        };
        const response = await fetch(`/api/usuario/${id}`, {
            method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados)
        });
        const result = await response.json();
        alert(result.message);
        if(response.ok) {
            editModal.hide();
            carregarUsuarios();
        }
    });
    
    carregarUsuarios();
});
</script>
{% endblock %}