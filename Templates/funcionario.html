{% extends "base.html" %}

{% block title %}Funcionário | Gw Barber{% endblock %}

{% block head %}
<style>
    /* Estilos específicos para o formulário e tabelas desta página */
    .form-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.75rem; padding: 2rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
    .form-card h1, .form-card h2 { text-align: center; color: var(--text-primary); font-weight: 600; margin-bottom: 2rem; }
    .form-label { font-weight: 500; color: var(--text-secondary); }
    .form-control, .form-select { background-color: var(--input-bg); border: 1px solid var(--content-border); color: var(--text-primary); padding: 0.75rem 1rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
    .form-control:focus, .form-select:focus { background-color: var(--content-bg); border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); color: var(--text-primary); }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; }
    .spinner-border { width: 4rem; height: 4rem; }
</style>
{% endblock %}


{% block content %}
<div class="overlay" id="loadingOverlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Salvando...</span>
    </div>
</div>

<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
</div>

<div class="container">
    <div class="form-card">
        <h2 class="mb-4">Painel de Pagamentos</h2>

        <div class="mb-3">
            <label for="barbeiro" class="form-label">Barbeiro</label>
            <select id="barbeiro" class="form-select" required>
                <option value="">Carregando barbeiros...</option>
            </select>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="data_inicio" class="form-label">De</label>
                <input type="date" id="data_inicio" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label for="data_fim" class="form-label">Até</label>
                <input type="date" id="data_fim" class="form-control" required>
            </div>
        </div>

        <div class="mb-3">
            <label for="valor" class="form-label">Valor</label>
            <input type="number" step="0.01" id="valor" class="form-control" placeholder="Valor a pagar" required>
        </div>

        <div class="mb-3">
            <label for="arquivo" class="form-label">Comprovante</label>
            <input type="file" id="arquivo" class="form-control" required>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <button id="buscar" class="btn btn-primary">Buscar Valores</button>
            <button id="pagar" class="btn btn-success">Registrar Pagamento</button>
            <button id="historicoPagamentosBtn" class="btn btn-info">Ver Histórico</button>
        </div>
    </div>
    
    <div class="mt-4" id="ultimo-pagamento-container">
        <h5 class="mt-4">Último pagamento do barbeiro</h5>
        <div id="tabela_pagamento"></div>
    </div>

    <div class="mt-4" id="resultado-container">
        <h5 class="mt-4">Resultado da busca</h5>
        <div id="resultado" class="table-responsive"></div>
    </div>
</div>

<div class="modal fade" id="historicoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Histórico de Pagamentos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Barbeiro</th>
                            <th>Valor</th>
                            <th>Data Início</th>
                            <th>Data Fim</th>
                            <th>Comprovante</th>
                        </tr>
                    </thead>
                    <tbody id="historicoTabela"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    }

    // Carregar barbeiros
    fetch('/api/barbeiros')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('barbeiro');
            select.innerHTML = '<option value="">Selecione um barbeiro</option>';
            data.forEach(b => {
                const opt = new Option(b, b);
                select.appendChild(opt);
            });
        });

    // Evento de seleção de barbeiro
    document.getElementById("barbeiro").addEventListener("change", function () {
        const barbeiro = this.value;
        const tabelaPagamento = document.getElementById("tabela_pagamento");
        if (!barbeiro) {
            tabelaPagamento.innerHTML = '';
            return;
        }

        fetch(`/api/pagamentos/${encodeURIComponent(barbeiro)}`)
            .then(res => res.json())
            .then(data => {
                if (!data.success || !data.pagamento) {
                    document.getElementById("data_inicio").value = '';
                    tabelaPagamento.innerHTML = '<div class="alert alert-info">Nenhum pagamento anterior encontrado para este barbeiro.</div>';
                    return;
                }
                const pag = data.pagamento;
                const dataFim = new Date(pag.fim);
                dataFim.setDate(dataFim.getDate() + 2); // Adiciona 2 dias para o início ser o dia seguinte
                document.getElementById("data_inicio").value = dataFim.toISOString().split('T')[0];

                tabelaPagamento.innerHTML = `
                    <table class="table table-bordered mt-2">
                        <thead class="table-light"><tr><th>Data Início</th><th>Data Fim</th><th>Valor</th></tr></thead>
                        <tbody><tr><td>${new Date(pag.inicio).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td><td>${new Date(pag.fim).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td><td>${formatarMoeda(pag.valor)}</td></tr></tbody>
                    </table>`;
            });
    });

    // Botão Buscar Dados
    document.getElementById('buscar').addEventListener('click', () => {
        const barbeiro = document.getElementById('barbeiro').value;
        const inicio = document.getElementById('data_inicio').value;
        const fim = document.getElementById('data_fim').value;

        if (!barbeiro || !inicio || !fim) return alert("Selecione o barbeiro e preencha as datas!");

        fetch(`/api/dashboard_data?barbeiro=${encodeURIComponent(barbeiro)}&inicio=${inicio}&fim=${fim}`)
            .then(res => res.json())
            .then(data => {
                const totalServicos = data.total_servicos_faturado || 0;
                const lucroVendas = data.liquido_vendas || 0; // Usando o lucro líquido das vendas
                const comissao = (totalServicos + lucroVendas) * 0.4;
                document.getElementById('valor').value = comissao.toFixed(2);

                const html = `
                    <table class="table table-sm table-bordered mt-2">
                        <thead class="table-light"><tr><th>Descrição</th><th>Valor</th></tr></thead>
                        <tbody>
                            <tr><td>Faturamento Serviços</td><td>${formatarMoeda(totalServicos)}</td></tr>
                            <tr><td>Lucro Líquido Vendas</td><td>${formatarMoeda(lucroVendas)}</td></tr>
                            <tr class="table-primary"><td><strong>Base de Cálculo (Soma)</strong></td><td><strong>${formatarMoeda(totalServicos + lucroVendas)}</strong></td></tr>
                            <tr class="table-success"><td><strong>Comissão (40%)</strong></td><td><strong>${formatarMoeda(comissao)}</strong></td></tr>
                        </tbody>
                    </table>`;
                document.getElementById('resultado').innerHTML = html;
            });
    });

    // Botão Pagar
    document.getElementById('pagar').addEventListener('click', () => {
        const formData = new FormData();
        formData.append('barbeiro', document.getElementById('barbeiro').value);
        formData.append('inicio', document.getElementById('data_inicio').value);
        formData.append('fim', document.getElementById('data_fim').value);
        formData.append('valor', document.getElementById('valor').value);
        formData.append('arquivo', document.getElementById('arquivo').files[0]);

        if (!formData.get('barbeiro') || !formData.get('inicio') || !formData.get('fim') || !formData.get('valor') || !formData.get('arquivo')) {
            return alert("Preencha todos os campos e selecione um arquivo!");
        }

        document.getElementById('loadingOverlay').style.display = 'flex';
        fetch('/api/pagar', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) window.location.reload();
            })
            .finally(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            });
    });

    // Botão Histórico
    document.getElementById("historicoPagamentosBtn").addEventListener("click", () => {
        const barbeiro = document.getElementById("barbeiro").value;
        if (!barbeiro) return alert("Selecione um barbeiro!");

        fetch(`/api/historico_pagamentos/${encodeURIComponent(barbeiro)}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("historicoTabela");
                tbody.innerHTML = "";
                if (data.pagamentos && data.pagamentos.length > 0) {
                    data.pagamentos.forEach(p => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${p.barbeiro}</td>
                                <td>${formatarMoeda(p.valor)}</td>
                                <td>${new Date(p.inicio).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                <td>${new Date(p.fim).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                <td><a href="${p.arquivo_url}" class="btn btn-outline-primary btn-sm" target="_blank">Ver</a></td>
                            </tr>`;
                    });
                } else {
                    tbody.innerHTML = "<tr><td colspan='5'>Nenhum histórico encontrado</td></tr>";
                }
                new bootstrap.Modal(document.getElementById('historicoModal')).show();
            });
    });
});
</script>
{% endblock %}