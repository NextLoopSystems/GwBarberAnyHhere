{% extends "base.html" %}

{% block title %}Lista de Vendas | Gw Barber{% endblock %}

{% block head %}
<style>
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
    .content-header h1 { font-weight: 700; margin-bottom: 0; color: var(--text-primary); font-size: 1.8rem; }
    .sale-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.5rem; transition: all 0.3s ease; }
    .sale-card .card-header { background-color: transparent; border-bottom: 1px solid var(--content-border); font-weight: 600; color: var(--text-primary); }
    .sale-card .detail-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--content-border); font-size: 0.9rem; }
    .sale-card .detail-item:last-child { border-bottom: none; }
    .sale-card .detail-label { color: var(--text-secondary); font-weight: 500; }
    .sale-card .detail-value { font-weight: 500; color: var(--text-primary); }
    .sale-card .card-footer { background-color: transparent; border-top: 1px solid var(--content-border); }
    .action-btn { color: var(--text-secondary); transition: color 0.2s ease-in-out; }
    .action-btn.btn-edit:hover { color: var(--accent-color); }
    .action-btn.btn-delete:hover { color: #dc3545; }
    .modal-content { background-color: var(--content-bg); color: var(--text-primary); border-color: var(--content-border); }
    .form-control[readonly] { background-color: var(--main-bg); }
    body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1 class="flex-grow-1 text-center"><i class="bi bi-card-checklist"></i> Vendas Registradas</h1>
</div>
  
<div id="sale-list-container" class="row">
    </div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"> <h5 class="modal-title">Editar Venda</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3"><label class="form-label">Produto</label><input type="text" class="form-control" id="edit-produto" readonly></div>
                    <div class="mb-3"><label for="edit-barbeiro" class="form-label">Barbeiro</label><input type="text" class="form-control" id="edit-barbeiro"></div>
                    <div class="mb-3"><label for="edit-data-venda" class="form-label">Data da Venda</label><input type="datetime-local" class="form-control" id="edit-data-venda"></div>
                </form>
            </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> <button type="button" class="btn btn-primary" id="save-changes-btn">Salvar Alterações</button> </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"> <h5 class="modal-title">Confirmar Exclusão</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta venda?</p>
                <p><strong>O que fazer com os itens do estoque?</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btn-delete-no-restock">Apenas Excluir</button>
                <button type="button" class="btn btn-success" id="btn-delete-and-restock">Excluir e Devolver</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const listContainer = document.getElementById('sale-list-container');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let vendasData = [];
    let vendaIdParaDeletar = null;

    function formatarData(dataStr) {
        if (!dataStr) return "";
        const d = new Date(dataStr);
        if (isNaN(d)) return "";
        const dLocal = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
        const dia = String(dLocal.getDate()).padStart(2, '0');
        const mes = String(dLocal.getMonth() + 1).padStart(2, '0');
        const ano = dLocal.getFullYear();
        const horas = String(dLocal.getHours()).padStart(2, '0');
        const minutos = String(dLocal.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${ano} ${horas}:${minutos}`;
    }

    function formatarValor(valor) {
        if (valor === null || valor === undefined) return "R$ 0,00";
        return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    function formatarParaInput(dataStr) {
        if (!dataStr) return '';
        const d = new Date(dataStr);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 16);
    }

    async function carregarVendas() {
        try {
            const response = await fetch("{{ url_for('api_vendas') }}");
            vendasData = await response.json();
            listContainer.innerHTML = '';
            
            if (vendasData.length === 0) {
                listContainer.innerHTML = `<div class="col-12"><div class="alert alert-info">Nenhuma venda registrada ainda.</div></div>`;
                return;
            }

            vendasData.forEach(venda => {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-4';
                col.setAttribute('data-id', venda.id);
                
                // MUDANÇA AQUI: Simplificado o HTML interno do card
                col.innerHTML = `
                <div class="card sale-card h-100 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="product-name text-truncate"><i class="bi bi-box-seam me-2"></i>${venda.produto_nome || ''}</span>
                        <span class="badge bg-success rounded-pill">${formatarValor(venda.valor_total)}</span>
                    </div>
                    <div class="card-body py-2">
                        <div class="detail-item"><span class="detail-label">Barbeiro:</span> <span class="detail-value">${venda.barbeiro || ''}</span></div>
                        <div class="detail-item"><span class="detail-label">Quantidade:</span> <span class="detail-value">${venda.quantidade || '0'} un.</span></div>
                        <div class="detail-item"><span class="detail-label">Data:</span> <span class="detail-value">${formatarData(venda.data_venda)}</span></div>
                    </div>
                    <div class="card-footer text-end bg-transparent">
                        <button class="btn btn-link text-decoration-none p-0 ms-3 action-btn btn-edit" title="Editar"><i class="bi bi-pencil-fill fs-5"></i></button>
                        <button class="btn btn-link text-decoration-none p-0 ms-3 action-btn btn-delete" title="Excluir"><i class="bi bi-trash-fill fs-5"></i></button>
                    </div>
                </div>`;
                listContainer.appendChild(col);
            });
        } catch (error) {
            console.error('Erro ao carregar vendas:', error);
            listContainer.innerHTML = `<div class="alert alert-danger">Não foi possível carregar os dados.</div>`;
        }
    }

    // O restante do script para deletar e editar continua igual...
    async function performDelete(id, restock) {
        deleteConfirmModal.hide();
        try {
            const url = `/api/venda/${id}?restock=${restock}`;
            const response = await fetch(url, { method: 'DELETE' });
            const result = await response.json();
            alert(result.message);
            if (response.ok) carregarVendas();
        } catch (error) { 
            alert('Falha ao deletar a venda.'); 
        }
    }
    
    listContainer.addEventListener('click', function (e) {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.closest('.col-lg-4').getAttribute('data-id');

        if (target.classList.contains('btn-delete')) {
            vendaIdParaDeletar = id;
            deleteConfirmModal.show();
        }

        if (target.classList.contains('btn-edit')) {
            const venda = vendasData.find(v => v.id == id);
            if (venda) { 
                document.getElementById('edit-id').value = venda.id; 
                document.getElementById('edit-produto').value = venda.produto_nome; 
                document.getElementById('edit-barbeiro').value = venda.barbeiro; 
                document.getElementById('edit-data-venda').value = formatarParaInput(venda.data_venda); 
                editModal.show();
            }
        }
    });

    document.getElementById('btn-delete-and-restock').addEventListener('click', () => {
        if (vendaIdParaDeletar) performDelete(vendaIdParaDeletar, true);
    });
    document.getElementById('btn-delete-no-restock').addEventListener('click', () => {
        if (vendaIdParaDeletar) performDelete(vendaIdParaDeletar, false);
    });
    
    document.getElementById('save-changes-btn').addEventListener('click', async function() {
        const id = document.getElementById('edit-id').value;
        const dados = { 
            barbeiro: document.getElementById('edit-barbeiro').value, 
            data_venda: document.getElementById('edit-data-venda').value 
        };
        try {
            const response = await fetch(`/api/venda/${id}`, { 
                method: 'PUT', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(dados) 
            });
            const result = await response.json();
            alert(result.message);
            if(response.ok) { 
                editModal.hide(); 
                carregarVendas(); 
            }
        } catch(error) { 
            alert('Falha ao atualizar a venda.'); 
        }
    });
    
    carregarVendas();
});
</script>
{% endblock %}