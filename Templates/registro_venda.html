{% extends "base.html" %}

{% block title %}Registro de Venda | Gw Barber{% endblock %}

{% block head %}
<style>
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
    .content-header h1 { font-weight: 700; margin-bottom: 0; }
    .form-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.75rem; padding: 2rem; }
    .form-card h1 { text-align: center; font-size: 1.8rem; font-weight: 600; margin-bottom: 2rem; color: var(--text-primary); }
    .form-label { font-weight: 500; color: var(--text-secondary); }
    .form-control, .form-select { background-color: var(--input-bg); border: 1px solid var(--content-border); color: var(--text-primary); }
    .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
    .btn:disabled { cursor: not-allowed; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 1050; justify-content: center; align-items: center; }
    .spinner-border { width: 4rem; height: 4rem; }

    .form-control:focus, .form-select:focus { 
        background-color: var(--content-bg); 
        border-color: var(--accent-color); 
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        color: var(--text-primary);
    }
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    select:-webkit-autofill,
    select:-webkit-autofill:hover,
    select:-webkit-autofill:focus {
        -webkit-text-fill-color: var(--text-primary) !important;
        -webkit-box-shadow: 0 0 0 30px var(--input-bg) inset !important;
        transition: background-color 5000s ease-in-out 0s;
    }
</style>
{% endblock %}

{% block content %}
<div class="overlay" id="loadingOverlay"><div class="spinner-border text-light" role="status"></div></div>

<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1 class="flex-grow-1 text-center"><i class="bi bi-box-seam"></i> Registro de Venda</h1>
</div>

<div class="card shadow-sm form-card mx-auto" style="max-width: 600px;">
    <form id="formVenda">
        <div class="row g-3">
            <div class="col-12">
                <label for="produtoLista" class="form-label"><i class="bi bi-box"></i> Produtos em estoque</label>
                <select id="produtoLista" class="form-select"><option>Carregando...</option></select>
            </div>
            <div class="col-md-6">
                <label for="quantidade" class="form-label"><i class="bi bi-hash"></i> Quantidade</label>
                <input type="number" min="1" class="form-control" id="quantidade" placeholder="Ex: 1" required />
            </div>
            <div class="col-md-6">
                <label for="valor" class="form-label"><i class="bi bi-currency-dollar"></i> Valor Total</label>
                <input type="text" class="form-control" id="valor" placeholder="R$ 0,00" />
            </div>
            <div class="col-md-6">
                <label for="barbeiro" class="form-label"><i class="bi bi-person-badge"></i> Barbeiro</label>
                <select class="form-select" id="barbeiro">
                    <option value="Guilherme">Guilherme</option>
                    <option value="Diego">Diego</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="dataHoraVenda" class="form-label"><i class="bi bi-calendar-event"></i> Data e Hora</label>
                <input type="datetime-local" class="form-control" id="dataHoraVenda" required />
                <input type="hidden" id="lucro_venda">
            </div>
        </div>
        <button type="submit" id="btnEnviar" class="btn btn-primary w-100 mt-4 py-2 fs-5" disabled><i class="bi bi-send-fill"></i> Enviar</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const produtoSelect = document.getElementById("produtoLista");
    const valorInput = document.getElementById("valor");
    const quantidadeInput = document.getElementById("quantidade");
    const dataHoraInput = document.getElementById("dataHoraVenda");
    const btnEnviar = document.getElementById("btnEnviar");
    const lucroVendaInput = document.getElementById('lucro_venda');
    let produtos = [];
    // MUDANÇA 2: Adicionada a flag para controlar a edição manual
    let valorEditadoManualmente = false;

    function setInitialDateTime() {
        const now = new Date();
        dataHoraInput.value = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    }

    function formatarParaMoeda(valor) {
        return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    // MUDANÇA 3: Evento para formatar o valor enquanto o usuário digita e ativar a flag
    valorInput.addEventListener('input', (e) => {
        valorEditadoManualmente = true;
        let value = e.target.value.replace(/\D/g, '');
        if (value) {
            let numValue = parseFloat(value) / 100;
            e.target.value = formatarParaMoeda(numValue);
        } else {
            e.target.value = '';
        }
    });

    function atualizarUI() {
        const produtoNome = produtoSelect.value;
        const quantidade = parseInt(quantidadeInput.value, 10) || 0;
        const produto = produtos.find(p => p.nome_produto === produtoNome);

        if (produto && quantidade > 0) {
            // MUDANÇA 4: Só calcula o valor automaticamente se não foi editado pelo usuário
            if (!valorEditadoManualmente) {
                const total = parseFloat(produto.valor_unitario) * quantidade;
                valorInput.value = formatarParaMoeda(total);
            }
            
            const lucroUnitario = parseFloat(produto.lucro) || 0;
            lucroVendaInput.value = (lucroUnitario * quantidade).toFixed(2);
            
            if (quantidade > produto.quantidade) {
                btnEnviar.disabled = true;
                btnEnviar.innerHTML = `<i class="bi bi-x-circle-fill"></i> Estoque Insuficiente (${produto.quantidade} un.)`;
            } else {
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = `<i class="bi bi-send-fill"></i> Enviar Venda`;
            }
        } else {
            if (!valorEditadoManualmente) {
                valorInput.value = "R$ 0,00";
            }
            lucroVendaInput.value = '0.00';
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = `<i class="bi bi-send-fill"></i> Enviar Venda`;
        }
    }
    
    async function carregarProdutos() {
        try {
            const response = await fetch("{{ url_for('api_produtos') }}");
            produtos = await response.json();
            produtoSelect.innerHTML = "<option value=''>Selecione um produto...</option>";
            produtos.forEach(p => {
                if (p.quantidade > 0) {
                    const option = new Option(`${p.nome_produto} (Estoque: ${p.quantidade})`, p.nome_produto);
                    produtoSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error("Erro ao carregar produtos:", error);
            produtoSelect.innerHTML = "<option>Erro ao carregar</option>";
        }
    }

    produtoSelect.addEventListener("change", atualizarUI);
    quantidadeInput.addEventListener("input", atualizarUI);
    
    setInitialDateTime();
    carregarProdutos();

    document.getElementById("formVenda").addEventListener("submit", async (e) => {
        e.preventDefault();
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = "flex";

        const dados = {
            barbeiro: document.getElementById("barbeiro").value,
            produto: produtoSelect.value,
            quantidade: Number(quantidadeInput.value),
            valor: valorInput.value,
            dataHoraVenda: dataHoraInput.value,
            lucro_venda: parseFloat(lucroVendaInput.value)
        };

        try {
            const response = await fetch("{{ url_for('registro_venda') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dados)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            alert(result.message);
            e.target.reset();
            setInitialDateTime();
            await carregarProdutos();
            atualizarUI();

        } catch (error) {
            alert("Erro ao enviar: " + error.message);
        } finally {
            overlay.style.display = "none";
        }
    });
});
</script>
{% endblock %}