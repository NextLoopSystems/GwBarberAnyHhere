{% extends "base.html" %}

{% block title %}Registro de Gasto | Gw Barber{% endblock %}

{% block head %}
<style>
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
    .content-header h1 { font-weight: 700; margin-bottom: 0; }
    .form-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.75rem; padding: 2rem; }
    .form-card h1 { text-align: center; font-size: 1.8rem; font-weight: 600; margin-bottom: 2rem; color: var(--text-primary); }
    .form-label, .form-check-label { font-weight: 500; color: var(--text-secondary); } /* MUDANÇA AQUI */
    .form-control, .form-select, .form-check-input { background-color: var(--input-bg); border: 1px solid var(--content-border); color: var(--text-primary); }
    .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1050; justify-content: center; align-items: center; }
    .spinner-border { width: 4rem; height: 4rem; }

    /* Correção para o tema escuro nos inputs */
    .form-control:focus, .form-select:focus { 
        background-color: var(--content-bg); 
        border-color: var(--accent-color); 
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        color: var(--text-primary);
    }

    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
        -webkit-text-fill-color: var(--text-primary) !important;
        -webkit-box-shadow: 0 0 0 30px var(--input-bg) inset !important;
        transition: background-color 5000s ease-in-out 0s;
    }
    
    /* MUDANÇA AQUI: Garante que o texto do checkbox fique claro no modo escuro */
    body.dark-mode .form-check-label {
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="overlay" id="loadingOverlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Salvando...</span>
    </div>
</div>

<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1 class="flex-grow-1 text-center"><i class="bi bi-cash-coin"></i> Registro de Gasto</h1>
</div>

<div class="card shadow-sm form-card mx-auto" style="max-width: 600px;">
    <form id="formConta" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="nomeConta" class="form-label"><i class="bi bi-tag"></i> Descrição da Conta</label>
            <input type="text" class="form-control" id="nomeConta" name="nomeConta" placeholder="Ex: Conta de Luz" required />
        </div>

        <div class="mb-3">
            <label for="valorConta" class="form-label"><i class="bi bi-currency-dollar"></i> Valor</label>
            <input type="number" step="0.01" class="form-control" id="valorConta" name="valorConta" placeholder="Ex: 100,00" required />
        </div>

        <div class="mb-3">
            <label for="dataConta" class="form-label"><i class="bi bi-calendar-event"></i> Data</label>
            <input type="date" class="form-control" id="dataConta" name="dataConta" required />
        </div>

        <div class="mb-3">
            <label for="arquivoConta" class="form-label"><i class="bi bi-file-earmark-arrow-up"></i> Anexar Arquivo (Opcional)</label>
            <input type="file" class="form-control" id="arquivoConta" name="arquivoConta" accept=".pdf,.jpg,.png" />
        </div>
        
        <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="amortizarCheck"/>
            <label class="form-check-label" for="amortizarCheck">Quero amortizar esse custo</label>
        </div>

        <div class="mb-3" id="amortizarMesesGroup" style="display: none;">
            <label for="mesesAmortizar" class="form-label"><i class="bi bi-calendar-range"></i> Quantidade de Meses</label>
            <input type="number" min="1" class="form-control" id="mesesAmortizar" name="mesesAmortizar" placeholder="Ex: 12" />
        </div>

        <div class="mb-3" id="valorAmortizadoGroup" style="display: none;">
            <label class="form-label"><i class="bi bi-calculator"></i> Valor Mensal Amortizado</label>
            <input type="text" class="form-control" id="valorAmortizado" readonly />
        </div>

        <button type="submit" class="btn btn-success w-100 mt-4 py-2 fs-5">
            <i class="bi bi-send-fill"></i> Salvar Gasto
        </button>
    </form>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('formConta');
    const amortizarCheck = document.getElementById('amortizarCheck');
    const mesesAmortizar = document.getElementById('mesesAmortizar');
    const valorAmortizado = document.getElementById('valorAmortizado');
    const amortizarMesesGroup = document.getElementById('amortizarMesesGroup');
    const valorAmortizadoGroup = document.getElementById('valorAmortizadoGroup');
    const valorConta = document.getElementById('valorConta');
    const overlay = document.getElementById('loadingOverlay');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        overlay.style.display = 'flex';
        
        const formData = new FormData(form);
        
        try {
            const resp = await fetch("{{ url_for('registro_conta') }}", {
                method: "POST",
                body: formData
            });
            const result = await resp.json();
            alert(result.message);
            if (resp.ok) {
                form.reset();
                amortizarMesesGroup.style.display = 'none';
                valorAmortizadoGroup.style.display = 'none';
            }
        } catch (err) {
            alert("Erro ao enviar: " + err.message);
        } finally {
            overlay.style.display = 'none';
        }
    });

    amortizarCheck.addEventListener('change', () => {
        const show = amortizarCheck.checked;
        amortizarMesesGroup.style.display = show ? 'block' : 'none';
        valorAmortizadoGroup.style.display = show ? 'block' : 'none';
    });

    function calcularAmortizacao() {
        const valor = parseFloat(valorConta.value) || 0;
        const meses = parseInt(mesesAmortizar.value) || 0;
        if (valor > 0 && meses > 0) {
            const mensal = valor / meses;
            valorAmortizado.value = mensal.toFixed(2).replace('.', ',');
        } else {
            valorAmortizado.value = '';
        }
    }

    valorConta.addEventListener('input', calcularAmortizacao);
    mesesAmortizar.addEventListener('input', calcularAmortizacao);
});
</script>
{% endblock %}