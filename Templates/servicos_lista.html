{% extends "base.html" %}

{% block title %}Lista de Serviços | Gw Barber{% endblock %}

{% block head %}
<style>
    .content-header { display: flex; align-items: center; gap: 15px; margin-bottom: 1.5rem; }
    .content-header h1 { font-weight: 700; margin-bottom: 0; color: var(--text-primary); font-size: 1.8rem; }
    .service-card { background-color: var(--content-bg); border: 1px solid var(--content-border); border-radius: 0.5rem; }
    
    /* ************************************** */
    /* MUDANÇA AQUI: Estilo do cabeçalho do card */
    /* Garante que o texto dentro do cabeçalho use a cor principal */
    .service-card .card-header { 
        background-color: transparent; 
        border-bottom: 1px solid var(--content-border); 
        font-weight: 600; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        color: var(--text-primary); /* Adicionado para garantir a cor do texto */
    }
    /* ************************************** */

    .service-card .detail-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--content-border); font-size: 0.9rem; }
    .service-card .detail-item:last-child { border-bottom: none; }
    .service-card .detail-label { color: var(--text-secondary); font-weight: 500; }
    .service-card .detail-value { font-weight: 500; color: var(--text-primary); }
    .service-card .card-footer { background-color: transparent; border-top: 1px solid var(--content-border); }
    .action-btn { color: var(--text-secondary); }
    .action-btn.btn-edit:hover { color: var(--accent-color); }
    .action-btn.btn-delete:hover { color: #dc3545; }
    .modal-content { background-color: var(--content-bg); color: var(--text-primary); border-color: var(--content-border); }
    .modal-header { border-bottom-color: var(--content-border); }
    .modal-footer { border-top-color: var(--content-border); }
    .form-label { font-weight: 500; color: var(--text-secondary); }
    .form-control, .form-select { background-color: var(--input-bg); border-color: var(--content-border); color: var(--text-primary); }
    .form-control:focus, .form-select:focus { background-color: var(--content-bg); border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); }
    body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
</style>
{% endblock %}


{% block content %}
<div class="content-header">
    <button id="sidebar-toggle"><i class="bi bi-list"></i></button>
    <h1 class="flex-grow-1 text-center"><i class="bi bi-card-list"></i> Serviços Registrados</h1>
</div>
  
<div id="service-list-container" class="row">
    </div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-fill"></i> Editar Serviço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="edit-id">
                    <div class="row g-3">
                        <div class="col-md-6"><label for="edit-barbeiro" class="form-label">Barbeiro</label><input type="text" class="form-control" id="edit-barbeiro"></div>
                        <div class="col-md-6"><label for="edit-servico" class="form-label">Serviço</label><input type="text" class="form-control" id="edit-servico" readonly></div>
                        <div class="col-12"><label for="edit-cliente" class="form-label">Cliente</label><input type="text" class="form-control" id="edit-cliente" readonly></div>
                        <div class="col-md-6"><label for="edit-valor" class="form-label">Valor</label><input type="number" step="0.01" class="form-control" id="edit-valor" readonly></div>
                        <div class="col-md-6"><label for="edit-data-servico" class="form-label">Data do Serviço</label><input type="datetime-local" class="form-control" id="edit-data-servico"></div>
                        <div class="col-12"><label for="edit-data-final" class="form-label">Data Final (Assinatura)</label><input type="date" class="form-control" id="edit-data-final" readonly></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-changes-btn">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const listContainer = document.getElementById('service-list-container');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    let servicosData = [];

    function formatarData(dataStr, isDateOnly = false) {
        if (!dataStr) return "N/A";
        const d = new Date(dataStr);
        if (isNaN(d)) return "Data inválida";
        const dLocal = new Date(d.valueOf() + d.getTimezoneOffset() * 60000);
        const dia = String(dLocal.getDate()).padStart(2, '0');
        const mes = String(dLocal.getMonth() + 1).padStart(2, '0');
        const ano = dLocal.getFullYear();
        if (isDateOnly) return `${dia}/${mes}/${ano}`;
        const horas = String(dLocal.getHours()).padStart(2, '0');
        const minutos = String(dLocal.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${ano} ${horas}:${minutos}`;
    }

    function formatarValor(valor) {
        return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    function formatarParaInputDatetime(dataStr) {
        if (!dataStr) return '';
        const d = new Date(dataStr);
        if (isNaN(d)) return '';
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 16);
    }
    
    function formatarParaInputDate(dataStr) {
        if (!dataStr) return '';
        const d = new Date(dataStr);
        if (isNaN(d)) return '';
        d.setDate(d.getDate() + 1);
        return d.toISOString().split('T')[0];
    }

    async function carregarServicos() {
        try {
            const response = await fetch("{{ url_for('api_servicos') }}");
            if (!response.ok) throw new Error(`Erro do servidor: ${response.status}`);
            servicosData = await response.json();
            listContainer.innerHTML = '';
            
            if (servicosData.length === 0) {
                listContainer.innerHTML = `<div class="col-12"><div class="alert alert-info">Nenhum serviço registrado.</div></div>`;
                return;
            }

            servicosData.forEach(servico => {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-4';
                col.setAttribute('data-id', servico.id);
                
                col.innerHTML = `
                <div class="card service-card h-100 shadow-sm">
                    <div class="card-header">
                        <span class="text-truncate"><i class="bi bi-person-circle me-2"></i>${servico.cliente || ''}</span>
                        <span class="badge bg-primary rounded-pill">${servico.servico || ''}</span>
                    </div>
                    <div class="card-body py-2">
                        <div class="detail-item"><span class="detail-label">Barbeiro:</span> <span class="detail-value">${servico.barbeiro || ''}</span></div>
                        <div class="detail-item"><span class="detail-label">Valor:</span> <span class="detail-value fw-bold">${formatarValor(servico.valor)}</span></div>
                        <div class="detail-item"><span class="detail-label">Data:</span> <span class="detail-value">${formatarData(servico.data_servico)}</span></div>
                        ${servico.data_final ? `<div class="detail-item"><span class="detail-label">Venc. Assinatura:</span> <span class="detail-value">${formatarData(servico.data_final, true)}</span></div>` : ''}
                    </div>
                    <div class="card-footer text-end bg-transparent">
                        <button class="btn btn-link text-decoration-none p-0 ms-3 action-btn btn-edit" title="Editar"><i class="bi bi-pencil-fill fs-5"></i></button>
                        <button class="btn btn-link text-decoration-none p-0 ms-3 action-btn btn-delete" title="Excluir"><i class="bi bi-trash-fill fs-5"></i></button>
                    </div>
                </div>`;
                listContainer.appendChild(col);
            });
        } catch (error) {
            console.error('Erro ao carregar serviços:', error);
            listContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger">Não foi possível carregar os dados.</div></div>`;
        }
    }

    listContainer.addEventListener('click', async function (e) {
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.closest('.col-lg-4').getAttribute('data-id');

        if (target.classList.contains('btn-delete')) {
            if (confirm(`Tem certeza que deseja excluir o serviço ID ${id}?`)) {
                const response = await fetch(`/api/servico/${id}`, { method: 'DELETE' });
                const result = await response.json();
                alert(result.message);
                if (response.ok) carregarServicos();
            }
        }

        if (target.classList.contains('btn-edit')) {
            const servico = servicosData.find(s => s.id == id);
            if (servico) {
                document.getElementById('edit-id').value = servico.id;
                document.getElementById('edit-barbeiro').value = servico.barbeiro;
                document.getElementById('edit-servico').value = servico.servico;
                document.getElementById('edit-cliente').value = servico.cliente;
                document.getElementById('edit-valor').value = servico.valor;
                document.getElementById('edit-data-servico').value = formatarParaInputDatetime(servico.data_servico);
                document.getElementById('edit-data-final').value = formatarParaInputDate(servico.data_final);
                editModal.show();
            }
        }
    });
    
    document.getElementById('save-changes-btn').addEventListener('click', async function() {
        const id = document.getElementById('edit-id').value;
        const dados = {
            barbeiro: document.getElementById('edit-barbeiro').value,
            servico: document.getElementById('edit-servico').value,
            cliente: document.getElementById('edit-cliente').value,
            valor: document.getElementById('edit-valor').value,
            data_servico: document.getElementById('edit-data-servico').value,
            data_final: document.getElementById('edit-data-final').value,
        };
        const response = await fetch(`/api/servico/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
        const result = await response.json();
        alert(result.message);
        if(response.ok) {
            editModal.hide();
            carregarServicos();
        }
    });
    
    carregarServicos();
});
</script>
{% endblock %}